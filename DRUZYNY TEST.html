<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wyniki turniejów — Progressive Disclosure</title>
  <style>
    :root{
      --bg: #0f0f10;           /* prawie czarne */
      --panel: #161718;        /* ciemny szary */
      --panel-2: #1d1f21;      /* ciut jaśniejszy */
      --text: #eaeaea;         /* jasny tekst */
      --muted: #b3b3b3;        /* opis */
      --line: #2a2d31;         /* delikatne linie */
      --gold: #ffd700;         /* akcent złoty */
      --shadow: 0 8px 28px rgba(0,0,0,.35);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text); font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    a{color:var(--text)}

    /* Layout */
    .container{max-width:1200px;margin:0 auto;padding:24px}
    .header{display:flex;align-items:center;gap:16px;margin-bottom:20px}
    .dot{width:10px;height:10px;border-radius:999px;background:var(--gold);box-shadow:0 0 0 4px rgba(255,215,0,.12)}
    h1{font-size:22px;margin:0}
    .sub{color:var(--muted);font-size:14px}

    .cards{display:flex;flex-direction:row;gap:16px;justify-content:center;flex-wrap:wrap;margin:0 auto}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid var(--line);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);position:relative;overflow:hidden;width:280px;height:400px}
    .card h2{font-size:16px;margin:0 0 8px 0}
    .meta{display:flex;gap:12px;color:var(--muted);font-size:12px;margin-bottom:12px}
    .bars{display:flex;flex-direction:column;gap:8px;max-height:280px;overflow:auto;border-top:1px dashed var(--line);padding-top:12px}
    
    /* Custom scrollbar for bars */
    .bars::-webkit-scrollbar {
      width: 6px;
    }
    .bars::-webkit-scrollbar-track {
      background: #000;
      border-radius: 3px;
    }
    .bars::-webkit-scrollbar-thumb {
      background: var(--gold);
      border-radius: 3px;
    }
    .bars::-webkit-scrollbar-thumb:hover {
      background: #e6c200;
    }
    
    /* Firefox scrollbar */
    .bars {
      scrollbar-width: thin;
      scrollbar-color: var(--gold) #000;
    }
    .bar{display:grid;grid-template-columns: 1fr auto;align-items:center;gap:10px}
    .bar .label{font-size:12px;color:#d9d9d9;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .region{font-size:10px;color:var(--gold);margin-left:6px;opacity:0.8}
    .bar .track{height:8px;background:#2a2a2a;border-radius:999px;position:relative}
    .bar .fill{position:absolute;inset:0;width:40%;background:var(--gold);border-radius:999px}
    .bar .value{font-size:12px;color:var(--muted)}
    .btn{appearance:none;background:#222;border:1px solid var(--line);color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer;font-size:12px}
    .btn:hover{background:#26292b}
    .btn.gold{background:var(--gold);color:#000;border:0;font-weight:600}

    /* Detail view */
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:12px}
    .select, .segmented{background:#1b1d20;border:1px solid var(--line);border-radius:12px;padding:8px 10px;color:var(--text);font-size:12px}
    .segmented button{background:transparent;border:0;color:var(--muted);padding:6px 10px;border-radius:8px;cursor:pointer}
    .segmented button.active{color:#000;background:var(--gold);font-weight:700}

    .detail{display:grid;grid-template-columns: 1fr;gap:16px}
    @media(min-width:1000px){.detail{grid-template-columns: 1fr 320px}}

    .panel{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid var(--line);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}

    .heatmap{overflow:auto}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{position:relative}
    thead th{position:sticky;top:0;background:#141517;border-bottom:1px solid var(--line);z-index:2}
    th,td{padding:8px 8px;border-right:1px solid #1e2023}
    th:last-child, td:last-child{border-right:0}
    tbody tr:nth-child(2n){background:#151618}
    tbody tr:hover{background:#191b1e}

    .th-team{left:0;position:sticky;background:#141517;z-index:3;border-right:1px solid var(--line)}

    .cell{display:flex;align-items:center;justify-content:center;min-width:44px;height:36px;border-radius:8px}
    .cell-inner{display:inline-block;padding:6px 8px;border-radius:8px;font-weight:600;font-size:12px;min-width:28px;text-align:center;border:1px solid rgba(255,255,255,.06)}
    .cell-empty{display:inline-block;padding:6px 8px;border-radius:8px;min-width:28px;text-align:center;border:1px dashed var(--line);background:transparent;color:var(--muted);font-size:10px}

    .legend{display:flex;gap:10px;flex-wrap:wrap;font-size:12px;color:var(--muted)}
    .legend .sw{width:18px;height:12px;border-radius:4px;background:#333;border:1px solid #444}

    .side h3{margin:0 0 8px 0;font-size:14px}
    .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:10px 0}
    .stat{background:#1a1c1f;border:1px solid var(--line);border-radius:12px;padding:10px;text-align:center}
    .stat .v{font-size:18px;font-weight:800}
    .stat .l{font-size:12px;color:var(--muted)}

    .chart{width:100%;height:160px;background:#101114;border:1px solid var(--line);border-radius:12px;display:flex;align-items:center;justify-content:center}
    svg{display:block;width:100%;height:100%}
    .axis line{stroke:#3a3d41}
    .axis text{fill:#9a9a9a;font-size:10px}
    .stroke-gold{stroke:var(--gold)}

    .back{margin:0 0 12px 0;display:flex;gap:8px;align-items:center}
    .back .chev{width:10px;height:10px;border-left:2px solid var(--text);border-bottom:2px solid var(--text);transform:rotate(45deg)}

    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 8px;border-radius:999px;background:#1c1e22;border:1px solid var(--line);font-size:12px;color:var(--muted)}
    .badge .dot{width:8px;height:8px}

    .season-breakdown{margin-top:12px;padding-top:12px;border-top:1px solid var(--line)}
    .season-breakdown h4{margin:0 0 8px 0;font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px}
    .season-row{display:flex;justify-content:space-between;align-items:center;padding:4px 0;font-size:12px}
    .season-row .season-name{color:var(--text)}
    .season-row .season-avg{color:var(--gold);font-weight:600}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="dot"></div>
      <div>
        <h1>Wyniki turniejów — 5 seasons (4 + Summary), 33 drużyny</h1>
        <div class="sub">Widok warstwowy: najpierw przegląd sezonów, potem heatmapa, a na końcu szczegóły drużyny. Kolory: czarny/szary + złoty (#ffd700).</div>
      </div>
    </div>

    <!-- SEASONS OVERVIEW -->
    <div id="view-seasons">
      <div class="cards" id="seasonCards"></div>
    </div>

    <!-- SEASON DETAIL (HEATMAP) -->
    <div id="view-detail" style="display:none">
      <div class="back"><span class="chev"></span><button class="btn" onclick="goHome()">Season select</button></div>
      <div class="toolbar">
        <div class="badge"><span class="dot"></span><span id="titleSeason">Season</span></div>
        <div class="segmented" role="group" aria-label="Filtr typu" id="typeFilter">
          <button data-type="ALL" class="active">All</button>
          <button data-type="FNCS">FNCS Division 1 Finals</button>
          <button data-type="B">FNCS Grand Finals</button>
        </div>
        <select class="select" id="sortSelect">
          <option value="avg">Sort by average position</option>
          <option value="wins">Sort by number of wins</option>
          <option value="alpha">Sort alphabetically</option>
        </select>
      </div>

      <div class="detail">
        <div class="panel heatmap">
          <div class="legend" style="margin-bottom:8px;display:none">
            <span><span class="sw" style="background:var(--gold);border:0"></span> 1. place</span>
            <span><span class="sw" style="background:#d0d0d0"></span> better placement</span>
            <span><span class="sw" style="background:#444"></span> worse placement</span>
          </div>
          <div id="heatmapWrap"></div>
        </div>

        <div class="panel side" id="sidePanel">
          <h3 id="sideTitle">Choose a team</h3>
          <div class="stats">
            <div class="stat"><div class="v" id="stAvg">—</div><div class="l">Avg placement</div></div>
            <div class="stat"><div class="v" id="stBest">—</div><div class="l">Best result</div></div>
            <div class="stat"><div class="v" id="stWins">—</div><div class="l">Wins</div></div>
          </div>
          <div class="chart" id="chart"></div>
          <div class="stats" style="grid-template-columns:repeat(2,1fr)">
            <div class="stat"><div class="v" id="stA">—</div><div class="l">Avg position - DIV 1</div></div>
            <div class="stat"><div class="v" id="stB">—</div><div class="l">Avg position - FNCS GRANDS</div></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- DEMO DANE: generujemy spójny zestaw dla 33 drużyn, 4 sezony, 2 typy turniejów ---
    const TEAMS = [
  "VENO VICO FLICKZY",
  "MALIBUCA P1NGFNZ WOX",
  "MARIUSCOW VANYAK3K PIXIE",
  "FREDOXIE PABLOWINGU TJINO",
  "DARM DEMUŚ PIXX",
  "MERSTACH QUEASY SWIZZY",
  "TAYSON CHICO HRIS",
  "SETTY JAPKO PANZER",
  "FOCUS MIKSON UPL",
  "IDROP KAMI CHARYY",
  "MRSAVAGE REZON CHAP",
  "ACORN POLLO AJERSS",
  "PETERBOT RITUAL COLD",
  "CLIX EOMZO HIGGS",
  "COOPER REET CURLY",
  "AMINISHED BRAYDZ VISXALS",
  "KHANADA RAPID BOLTZ",
  "MUZ SHADOW SPHINX",
  "BACCA PARZ PXMP",
  "ARK SALKO SXHOOL",
  "EPIKWHALE PAPER VICTERV",
  "K1NG FAZER PHZIN",
  "CADU STRYKER TISCO",
  "GABZERA SCARPA WEY",
  "FKS HERO 5AALD",
  "REW SAAD SNOWY",
  "BALOR ADAPTER MANSOUR",
  "ALEX ANON RESIGNZ",
  "TINKA CAZI ASPECT",
  "VORTEXM MOUNTAIN GOOFY",
  "KOYOTA YUMA RISE",
  "RAITO RAZL KIMKANA",
  "MEREM WICKESY BUYURIRU"
];
    const SEASONS = [1,2,3,4];

    // Random regions for teams
    const TEAM_REGIONS = {};
    TEAMS.forEach(team => {
      TEAM_REGIONS[team] = Math.random() > 0.5 ? 'EU' : 'NAC';
    });

    const rng = mulberry32(42);
const seasons = SEASONS.map(s => {
  const tournaments = [
    {id: `S${s}T1`, name: `Week 1`, type: 'A', date: new Date(2020+s, 0, 15).toISOString().slice(0,10)},
    {id: `S${s}T2`, name: `Week 2`, type: 'A', date: new Date(2020+s, 1, 15).toISOString().slice(0,10)},
    {id: `S${s}T3`, name: `Week 3`, type: 'A', date: new Date(2020+s, 2, 15).toISOString().slice(0,10)},
    {id: `S${s}T4`, name: `Week 4`, type: 'A', date: new Date(2020+s, 3, 15).toISOString().slice(0,10)},
    {id: `S${s}T5`, name: `Week 5`, type: 'A', date: new Date(2020+s, 4, 15).toISOString().slice(0,10)},
    {id: `S${s}T6`, name: `Grands`, type: 'B', date: new Date(2020+s, 5, 15).toISOString().slice(0,10)}
  ];

  // Define which teams participated in which tournaments
  const participationRules = {
    1: {
      "VENO VICO FLICKZY": ["S1T1", "S1T2", "S1T3", "S1T4", "S1T5"],
      "MALIBUCA P1NGFNZ WOX": ["S1T1", "S1T2", "S1T3", "S1T4", "S1T5"],
      "MARIUSCOW VANYAK3K PIXIE": ["S1T3", "S1T5"],
      "FREDOXIE PABLOWINGU TJINO": [], // didn't participate in season 1
      "DARM DEMUŚ PIXX": ["S1T1", "S1T2", "S1T3", "S1T4"],
      "MERSTACH QUEASY SWIZZY": ["S1T1", "S1T2", "S1T4", "S1T5"],
      "TAYSON CHICO HRIS": [] // didn't participate in season 1
    },
    2: {
      // Season 2 - some teams missing from various weeks
      "FREDOXIE PABLOWINGU TJINO": ["S2T1", "S2T3", "S2T4", "S2T5", "S2T6"],
      "TAYSON CHICO HRIS": ["S2T2", "S2T3", "S2T4", "S2T5", "S2T6"]
    }
  };

  // Manual placements for season 1
  const manualPlacements = s === 1 ? {
    "VENO VICO FLICKZY": { "S1T1": 1, "S1T2": 2, "S1T3": 1, "S1T4": 4, "S1T5": 3 },
    "MALIBUCA P1NGFNZ WOX": { "S1T1": 14, "S1T2": 5, "S1T3": 7, "S1T4": 2, "S1T5": 4 },
    "MARIUSCOW VANYAK3K PIXIE": { "S1T3": 3, "S1T5": 2 },
    "DARM DEMUŚ PIXX": { "S1T1": 25, "S1T2": 1, "S1T3": 9, "S1T4": 15 },
    "MERSTACH QUEASY SWIZZY": { "S1T1": 6, "S1T2": 27, "S1T4": 5, "S1T5": 8 }
  } : {};

  const base = TEAMS.map(()=> 0.6 + rng()*0.8);
  const results = {};

  TEAMS.forEach((team, ti) => {
    results[team] = tournaments.map((t, idx) => {
      // Check if team participated in this tournament
      const seasonRules = participationRules[s];
      if (seasonRules && seasonRules[team] !== undefined) {
        if (!seasonRules[team].includes(t.id)) {
          return null; // Team didn't participate
        }
      } else if (seasonRules && seasonRules[team] === undefined && Object.keys(seasonRules).length > 0) {
        // If season has participation rules but team is not listed, they participated in all tournaments
      }

      // Use manual placement if available
      if (manualPlacements[team] && manualPlacements[team][t.id] !== undefined) {
        return { place: manualPlacements[team][t.id], type: t.type, tId: t.id };
      }

      // Generate random placement for participating teams
      const typeBias = t.type==='A' ? -0.1 + rng()*0.2 : -0.1 + rng()*0.2;
      const raw = base[ti] + (rng()-0.5)*0.6 + typeBias + idx*0.02*(rng()-0.5);
      let place = clamp(Math.round(mapRange(raw, 0.2, 1.8, 1, TEAMS.length)), 1, TEAMS.length);
      return { place, type: t.type, tId: t.id };
    });
  });

  return { season: s, tournaments, results };
});

// Create Summary season
const summaryTournaments = [];
const summaryResults = {};

// Collect all tournaments from seasons 1, 3, 4 (excluding season 2)
[1, 3, 4].forEach(seasonNum => {
  const season = seasons.find(s => s.season === seasonNum);
  season.tournaments.forEach(t => {
    summaryTournaments.push({
      ...t,
      id: t.id,
      name: `S${seasonNum} ${t.name}`,
      originalSeason: seasonNum
    });
  });
});

// Collect results for summary
TEAMS.forEach(team => {
  summaryResults[team] = [];
  [1, 3, 4].forEach(seasonNum => {
    const season = seasons.find(s => s.season === seasonNum);
    season.results[team].forEach(result => {
      summaryResults[team].push(result);
    });
  });
});

const summarySeason = {
  season: 'Summary',
  tournaments: summaryTournaments,
  results: summaryResults
};

seasons.push(summarySeason);

    // --- Widok 1: Karty sezonów (skrót) ---
    const seasonCardsEl = document.getElementById('seasonCards');
    seasons.forEach(season => {
      const {season: s} = season;
      const stats = summarizeSeason(season, 'ALL');
      const sorted = Object.entries(stats.teamAvg)
        .filter(([team, avg]) => isFinite(avg)) // Only show teams with valid averages
        .sort((a,b)=>a[1]-b[1]);
      const top = sorted.slice(0,10);

      const card = document.createElement('div');
      card.className='card';
      
      let seasonTitle, tournamentInfo;
      if (s === 'Summary') {
        seasonTitle = 'Summary (S1, S3, S4)';
        tournamentInfo = 'All tournaments from seasons 1, 3, 4';
      } else {
        seasonTitle = `Season ${s}`;
        tournamentInfo = `${season.tournaments.length} tournaments`;
      }
      
      card.innerHTML = `
        <h2>${seasonTitle}</h2>
        <div class="meta">
          <span>Tournaments: <strong>${season.tournaments.length}</strong></span>
          <span>Type: <strong>DIV / FNCS</strong></span>
        </div>
        <div class="bars" id="bars-${s}"></div>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn gold" data-open="${s}">View Details</button>
          <button class="btn" data-showall="${s}">Show All Teams</button>
        </div>
      `;
      seasonCardsEl.appendChild(card);

      // narysuj top 10
      renderBars(`bars-${s}`, top, stats.maxAvg);

      // akcje
      card.querySelector('[data-open]').addEventListener('click', ()=> openSeason(s));
      const showAllBtn = card.querySelector('[data-showall]');
      let isShowingAll = false;
      showAllBtn.addEventListener('click', (e)=>{
        if (!isShowingAll) {
          const all = sorted; // wszystkie
          renderBars(`bars-${s}`, all, stats.maxAvg);
          e.target.textContent = 'Show Top 10';
          isShowingAll = true;
        } else {
          renderBars(`bars-${s}`, top, stats.maxAvg);
          e.target.textContent = 'Show All Teams';
          isShowingAll = false;
        }
      });
    });

    function renderBars(containerId, items, maxAvg){
      const el = document.getElementById(containerId);
      el.innerHTML = '';
      // Filter out teams with no valid placements (Infinity average)
      const validItems = items.filter(([team, avg]) => isFinite(avg));
      validItems.forEach(([team, avg])=>{
        const wrap = document.createElement('div');
        wrap.className = 'bar';
        const pct = (1 - (avg-1)/(TEAMS.length-1)) * 100; // lepsza średnia => dłuższy złoty pasek
        wrap.innerHTML = `
          <div class="label">${team}<span class="region">${TEAM_REGIONS[team]}</span></div>
          <div style="display:flex;align-items:center;gap:8px">
            <div class="track" aria-hidden="true">
              <div class="fill" style="width:${pct.toFixed(1)}%"></div>
            </div>
            <div class="value">${avg.toFixed(2)}</div>
          </div>
        `;
        el.appendChild(wrap);
      })
    }

    // --- Widok 2: Heatmapa sezonu + panel ---
    const viewSeasons = document.getElementById('view-seasons');
    const viewDetail = document.getElementById('view-detail');
    const heatmapWrap = document.getElementById('heatmapWrap');
    const titleSeason = document.getElementById('titleSeason');
    const typeFilter = document.getElementById('typeFilter');
    const sortSelect = document.getElementById('sortSelect');

    let currentSeason = null;
    let currentType = 'ALL';
    let currentSort = 'avg';
    let currentTeam = null;

    typeFilter.querySelectorAll('button').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        typeFilter.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        currentType = btn.dataset.type;
        renderHeatmap();
        if(currentTeam) selectTeam(currentTeam);
      })
    })
    sortSelect.addEventListener('change', ()=>{ currentSort = sortSelect.value; renderHeatmap(); })

    function goHome(){
      viewDetail.style.display='none';
      viewSeasons.style.display='block';
      currentTeam=null;
    }

    function openSeason(s){
      currentSeason = seasons.find(x=>x.season===s || x.season.toString()===s.toString());
      const displayTitle = s === 'Summary' ? 'Summary (S1, S3, S4)' : `Season ${s}`;
      titleSeason.textContent = displayTitle;
      viewSeasons.style.display='none';
      viewDetail.style.display='block';
      currentType = 'ALL';
      typeFilter.querySelectorAll('button').forEach(b=>b.classList.toggle('active', b.dataset.type==='ALL'));
      sortSelect.value = 'avg';
      currentSort = 'avg';
      renderHeatmap();
      resetSide();
    }

    function renderHeatmap(){
      const s = currentSeason; if(!s) return;
      // kolumny = turnieje po filtrze typu
      const colsIdx = s.tournaments
        .map((t,idx)=>({idx, t}))
        .filter(o=> currentType==='ALL' ? true : (currentType==='FNCS' ? o.t.type==='A' : o.t.type===currentType));

      // przefiltruj wyniki i policz metryki sortowania
      const teamRows = TEAMS.map(team=>{
        const cells = colsIdx.map(({idx,t})=>{
          const r = s.results[team][idx];
          if (!r) return null; // No participation
          return { place: r.place, type: r.type, tName: t.name, tId: t.id, date: t.date };
        });
        const places = cells.filter(c => c !== null).map(c=>c.place);
        const avg = places.length > 0 ? avgOf(places) : Infinity;
        const wins = places.filter(p=>p===1).length;
        return { team, cells, avg, wins, participationCount: places.length };
      });

      // sortowanie
      teamRows.sort((a,b)=>{
        if(currentSort==='avg') return a.avg - b.avg;
        if(currentSort==='wins') return b.wins - a.wins || a.avg - b.avg;
        if(currentSort==='alpha') return a.team.localeCompare(b.team);
        return 0;
      });

      // budowa tabeli
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const trh = document.createElement('tr');
      trh.appendChild(th('Team','th-team'));
      colsIdx.forEach(({t})=> trh.appendChild(th(t.name)) );
      thead.appendChild(trh);

      const tbody = document.createElement('tbody');
      teamRows.forEach(row=>{
        const tr = document.createElement('tr');
        const tdTeam = document.createElement('td');
        tdTeam.className='th-team';
        tdTeam.textContent = row.team;
        tr.appendChild(tdTeam);

        row.cells.forEach(c=>{
          const td = document.createElement('td');
          const cell = document.createElement('div');
          cell.className='cell';
          
          if (c === null) {
            // Empty cell for no participation
            const empty = document.createElement('div');
            empty.className='cell-empty';
            empty.textContent = '—';
            empty.title = 'Did not participate';
            cell.appendChild(empty);
          } else {
            const inner = document.createElement('div');
            inner.className='cell-inner';
            inner.textContent = c.place;
            const styles = colorForPlace(c.place, TEAMS.length);
            inner.style.background = styles.bg;
            inner.style.color = styles.fg;
            inner.title = `${c.tName} • ${c.date} • Miejsce: ${c.place} • Typ: ${c.type}`;
            cell.appendChild(inner);
          }
          
          td.appendChild(cell);
          tr.appendChild(td);
        })

        tr.addEventListener('click', ()=> selectTeam(row.team));
        tbody.appendChild(tr);
      })

      table.appendChild(thead); table.appendChild(tbody);
      heatmapWrap.innerHTML='';
      heatmapWrap.appendChild(table);
    }

    function th(text, extraClass=''){
      const th = document.createElement('th');
      th.textContent = text;
      if(extraClass) th.className = extraClass;
      return th;
    }

    function resetSide(){
      document.getElementById('sideTitle').textContent = 'Wybierz drużynę';
      ['stAvg','stBest','stWins','stA','stB'].forEach(id=> document.getElementById(id).textContent = '—');
      document.getElementById('chart').innerHTML = '';
    }

    function selectTeam(team){
      currentTeam = team;
      const s = currentSeason; if(!s) return;
      const seqAll = s.results[team].map((r,idx)=>({
        result: r, 
        idx, 
        t: s.tournaments[idx]
      })).filter(item => item.result !== null); // Filter out null results
      
      const seq = seqAll.filter((item,i)=>{
        const t = item.t;
        return currentType==='ALL' ? true : (currentType==='FNCS' ? t.type==='A' : t.type===currentType);
      });
      
      const places = seq.map(x=>x.result.place);
      const avg = places.length > 0 ? avgOf(places) : Infinity;
      const best = places.length > 0 ? Math.min(...places) : Infinity;
      const wins = places.filter(p=>p===1).length;

      // Śr. po typach
      const aPlaces = seqAll.filter(x=>x.result.type==='A').map(x=>x.result.place);
      const bPlaces = seqAll.filter(x=>x.result.type==='B').map(x=>x.result.place);
      const aAvg = aPlaces.length ? avgOf(aPlaces).toFixed(2) : '—';
      const bAvg = bPlaces.length ? avgOf(bPlaces).toFixed(2) : '—';

      document.getElementById('sideTitle').textContent = team;
      document.getElementById('stAvg').textContent = isFinite(avg) ? avg.toFixed(2) : '—';
      document.getElementById('stBest').textContent = isFinite(best) ? best : '—';
      document.getElementById('stWins').textContent = wins;
      document.getElementById('stA').textContent = aAvg;
      document.getElementById('stB').textContent = bAvg;

      // Add season breakdown for Summary view
      const sidePanel = document.getElementById('sidePanel');
      const existingBreakdown = sidePanel.querySelector('.season-breakdown');
      if (existingBreakdown) {
        existingBreakdown.remove();
      }

      if (s.season === 'Summary') {
        const breakdown = document.createElement('div');
        breakdown.className = 'season-breakdown';
        
        const title = document.createElement('h4');
        title.textContent = 'Season Breakdown';
        breakdown.appendChild(title);

        // Calculate averages for each season (1, 3, 4)
        [1, 3, 4].forEach(seasonNum => {
          const seasonTournaments = seqAll.filter(item => item.t.originalSeason === seasonNum);
          if (seasonTournaments.length > 0) {
            const seasonPlaces = seasonTournaments.map(x => x.result.place);
            const seasonAvg = avgOf(seasonPlaces);
            
            const row = document.createElement('div');
            row.className = 'season-row';
            row.innerHTML = `
              <span class="season-name">Season ${seasonNum}</span>
              <span class="season-avg">${seasonAvg.toFixed(2)}</span>
            `;
            breakdown.appendChild(row);
          }
        });

        sidePanel.appendChild(breakdown);
      }

      renderLineChart('chart', places);
    }

    // --- Wizualne narzędzia ---
    function colorForPlace(place, max){
      if(place===1) return { bg: 'var(--gold)', fg: '#000' };
      // skala szarości: 2 -> jasna, max -> ciemna
      const t = (place-2) / (Math.max(2, max-2));
      const v = Math.round(208 - t*128); // 208 -> 80
      const bg = `rgb(${v},${v},${v})`;
      const fg = v < 120 ? '#fff' : '#000';
      return { bg, fg };
    }

    function renderLineChart(containerId, data){
      const el = document.getElementById(containerId);
      el.innerHTML = '';
      const w = el.clientWidth || 280;
      const h = el.clientHeight || 160;
      const pad = {l:28,r:8,t:6,b:22};
      const x0 = pad.l, x1 = w - pad.r, y0 = pad.t, y1 = h - pad.b;

      const maxPlace = TEAMS.length;
      const n = data.length;
      if(n===0){ el.innerHTML='<div style="color:var(--muted);font-size:12px">Brak danych w wybranym filtrze.</div>'; return; }

      // skale
      const x = i => x0 + (i/(n-1))*(x1-x0);
      const y = p => y0 + ((p-1)/(maxPlace-1))*(y1-y0);

      // path
      let d = '';
      data.forEach((p,i)=>{ d += (i? 'L':'M') + x(i)+','+y(p) + ' '; })

      const svgNS = 'http://www.w3.org/2000/svg';
      const svg = document.createElementNS(svgNS, 'svg');
      svg.setAttribute('viewBox', `0 0 ${w} ${h}`);

      // osie Y (1, max)
      const axisG = document.createElementNS(svgNS,'g');
      axisG.setAttribute('class','axis');
      // linie tła
      [1, Math.ceil(maxPlace/2), maxPlace].forEach(val=>{
        const yy = y(val);
        const line = document.createElementNS(svgNS,'line');
        line.setAttribute('x1', x0); line.setAttribute('x2', x1); line.setAttribute('y1', yy); line.setAttribute('y2', yy);
        line.setAttribute('stroke', '#2a2d31');
        svg.appendChild(line);
        const txt = document.createElementNS(svgNS,'text');
        txt.setAttribute('x', x0-6); txt.setAttribute('y', yy+3); txt.setAttribute('text-anchor','end');
        txt.setAttribute('fill','#9a9a9a'); txt.setAttribute('font-size','10');
        txt.textContent = val;
        svg.appendChild(txt);
      })

      // ścieżka
      const path = document.createElementNS(svgNS,'path');
      path.setAttribute('d', d.trim());
      path.setAttribute('fill','none');
      path.setAttribute('stroke','var(--gold)');
      path.setAttribute('stroke-width','2');
      svg.appendChild(path);

      // punkty
      data.forEach((p,i)=>{
        const c = document.createElementNS(svgNS,'circle');
        c.setAttribute('cx', x(i)); c.setAttribute('cy', y(p)); c.setAttribute('r', 3);
        c.setAttribute('fill','var(--gold)'); c.setAttribute('stroke','#000'); c.setAttribute('stroke-width','0.5');
        svg.appendChild(c);
      })

      el.appendChild(svg);
    }

    // --- Agregacje ---
    function summarizeSeason(season, type='ALL'){
      const teamAvg = {};
      let maxAvg = 0;
      TEAMS.forEach(team=>{
        const places = season.results[team]
          .filter((r,idx)=> {
            if (!r) return false; // Skip null results
            return type==='ALL' ? true : season.tournaments[idx].type===type;
          })
          .map(r=>r.place);
        const avg = places.length > 0 ? avgOf(places) : Infinity;
        teamAvg[team] = avg;
        if(isFinite(avg) && avg>maxAvg) maxAvg=avg;
      })
      return { teamAvg, maxAvg }
    }

    // --- Utils ---
    function avgOf(arr){ if(!arr || !arr.length) return Infinity; return arr.reduce((a,b)=>a+b,0)/arr.length }
    function clamp(v,min,max){ return Math.max(min, Math.min(max, v)) }
    function mapRange(v, inMin, inMax, outMin, outMax){
      const t = (v - inMin) / (inMax - inMin); return outMin + t * (outMax - outMin);
    }
    function mulberry32(a){
      return function() {
        let t = a += 0x6D2B79F5;
        t = Math.imul(t ^ t >>> 15, t | 1);
        t ^= t + Math.imul(t ^ t >>> 7, t | 61);
        return ((t ^ t >>> 14) >>> 0) / 4294967296;
      }
    }
  </script>
</body>
</html>